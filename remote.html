<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Crown - premium responsive admin template for backend systems</title>
    <link href="css/main.css" rel="stylesheet" type="text/css" />

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>

    <script type="text/javascript" src="js/plugins/spinner/jquery.mousewheel.js"></script>

    <script type="text/javascript" src="js/plugins/charts/excanvas.min.js"></script>
    <script type="text/javascript" src="js/plugins/charts/jquery.sparkline.min.js"></script>

    <script type="text/javascript" src="js/plugins/forms/uniform.js"></script>
    <script type="text/javascript" src="js/plugins/forms/jquery.cleditor.js"></script>
    <script type="text/javascript" src="js/plugins/forms/jquery.validationEngine-en.js"></script>
    <script type="text/javascript" src="js/plugins/forms/jquery.validationEngine.js"></script>
    <script type="text/javascript" src="js/plugins/forms/jquery.tagsinput.min.js"></script>
    <script type="text/javascript" src="js/plugins/forms/jquery.autosize.js"></script>
    <script type="text/javascript" src="js/plugins/forms/jquery.maskedinput.min.js"></script>
    <script type="text/javascript" src="js/plugins/forms/jquery.dualListBox.js"></script>
    <script type="text/javascript" src="js/plugins/forms/jquery.inputlimiter.min.js"></script>
    <script type="text/javascript" src="js/plugins/forms/chosen.jquery.min.js"></script>

    <script type="text/javascript" src="js/plugins/wizard/jquery.form.js"></script>
    <script type="text/javascript" src="js/plugins/wizard/jquery.validate.min.js"></script>
    <script type="text/javascript" src="js/plugins/wizard/jquery.form.wizard.js"></script>

    <script type="text/javascript" src="js/plugins/uploader/plupload.js"></script>
    <script type="text/javascript" src="js/plugins/uploader/plupload.html5.js"></script>
    <script type="text/javascript" src="js/plugins/uploader/plupload.html4.js"></script>
    <script type="text/javascript" src="js/plugins/uploader/jquery.plupload.queue.js"></script>

    <script type="text/javascript" src="js/plugins/tables/datatable.js"></script>
    <script type="text/javascript" src="js/plugins/tables/tablesort.min.js"></script>
    <script type="text/javascript" src="js/plugins/tables/resizable.min.js"></script>

    <script type="text/javascript" src="js/plugins/ui/jquery.tipsy.js"></script>
    <script type="text/javascript" src="js/plugins/ui/jquery.collapsible.min.js"></script>
    <script type="text/javascript" src="js/plugins/ui/jquery.prettyPhoto.js"></script>
    <script type="text/javascript" src="js/plugins/ui/jquery.progress.js"></script>
    <script type="text/javascript" src="js/plugins/ui/jquery.timeentry.min.js"></script>
    <script type="text/javascript" src="js/plugins/ui/jquery.colorpicker.js"></script>
    <script type="text/javascript" src="js/plugins/ui/jquery.jgrowl.js"></script>
    <script type="text/javascript" src="js/plugins/ui/jquery.breadcrumbs.js"></script>
    <script type="text/javascript" src="js/plugins/ui/jquery.sourcerer.js"></script>

    <script type="text/javascript" src="js/plugins/jquery.fullcalendar.js"></script>
    <script type="text/javascript" src="js/plugins/jquery.elfinder.js"></script>

    <script type="text/javascript" src="js/custom.js"></script>


    <!-- add Script for button F1 browser - Open chat -->
    <script type="text/javascript" src="shortcut.js"></script>
    <style>
        .chat-box-handle {
            top: 40%;
            right: 16px;
            display: none;
            z-index: 30;
            position: fixed;
        }

        .chat-box-handle-active {
            display: block;
        }

        /* arrow left when chat box active */
        .chat-box-arrow {
            width: 0;
            top: 40%;
            left: -35px;
            z-index: 30;
            display: block;
            position: absolute;
            border-right: 35px solid #d7d7d7;
            border-bottom: 20px solid transparent;
        }

        .chat-box {
            height: auto;
            position: absolute;
            top: 25%;
            z-index: 20;
            background: #d7d7d7;
            border-top-left-radius: 3px;
            border-bottom-left-radius: 3px;
            min-width: 250px;
            display: none;

            /* left: 1177.95px; */
            /* right: 0; */
            /* transition: 0.2s ease-in-out; */
            /* opacity: 0; */
            /* visibility: hidden; */
            /* transform: translateX(75px); */
        }

        .chat-box-open {
            display: block;
            /* opacity: 1; */
            /* visibility: visible; */
            /* transform: translateX(0px); */
        }

        .title-chat {
            padding: 5px 0;
            background: #bbbaba;
            border-bottom: 2px solid;
            border-top-left-radius: 3px;
        }

        .title-chat span {
            padding-left: 5px;
        }

        .body-chat {
            font-size: 12px;
            padding: 8px;
        }

        .body-chat span {
            margin-left: 3px;
        }

        .list-connected,
        .conversation {
            overflow: auto;
            margin: 3px 0 6px 0;
            border-radius: 2px;
            background: white;
            border: 1px solid #a9a9a961;
        }

        .list-connected {
            height: 60px;
        }

        .conversation {
            height: 135px;
        }

        .conversation .chat-partner {
            padding: 5px 0 0px 5px;
        }

        .my-mess {
            color: grey;
        }

        .partner-mess {
            color: #00008bb8;
        }

        .btn-up-file {
            float: right;
            margin-top: 3px;
        }


        /* --------- UPLOAD FILE ----------- */
        /* Uploading file */
        .uploading-file {
            margin: 5px;
            background: lightblue;
            border-radius: 5px;
            /* padding: 5px; */
        }

        .progress {
            padding: 0 !important;
            background: lightblue;
            margin: 0 5px;
            text-align: center;
        }

        .progress .progress-bar {
            background: white;
        }

        .progress .progress-bar-uploading {
            width: 70%;
            color: #fff;
            text-align: center;
            /* margin: 3px 0 5px 0; */
            background-color: #337ab7;
            height: 20px;
        }

        .progress .file-size {
            font-size: 11px;
        }

        .file-info-1 {
            float: left;
            width: 15%;
        }

        .file-info-1 img {
            width: 30px;
            margin-top: 2px;
        }

        .file-info-1 .time-upload {
            margin-top: 2px;
        }

        .file-info-2 {
            float: left;
            width: 77%;
        }

        .file-info-3 {
            float: left;
            width: 8%;
        }

        .file-info-3 img {
            width: 15px;
            margin-top: 20px;
        }

        .progress .file-name {
            white-space: nowrap;
            max-width: 140px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Upload file success*/
        .upload-success {
            margin: 5px;
            background: lightblue;
            border-radius: 5px;
            padding: 5px;
        }

        .upload-success .progress {
            /* text-align: left; */
        }

        .upload-success .file-name {
            /* margin-top: 4px; */
        }

        .upload-success .file-size {
            /* font-size: 11px;
            margin-top: 2px; */
        }

        .upload-success .file-status {
            /* margin-top: 4px; */
            /* text-align: center; */
        }

        .user-chat-box {
            margin-top: 7px;
        }

        .user-chat-box .input-chat-box {
            margin: 0;
            padding: 5px;
            float: left;
            border-radius: 2px;
            width: 66%;
            border: 1px solid #a9a9a961;
        }

        .user-chat-box .image-upload img {
            width: 25px;
            float: left;
            margin-top: 3px;
            margin-left: 10px;
        }

        .user-chat-box #file_input {
            display: none;
        }

        .send-message {
            width: 25px;
            float: right;
            margin-top: 3px;
        }

        .chat-box .title-chat .title-label {
            float: left;
            margin-top: 3px;
        }

        .chat-box .title-chat .title-btn-close {
            width: 22px;
            float: right;
            margin-right: 3px;
        }

        .list-connected .connect-description {
            padding: 5px;
            background: white;
            text-transform: uppercase;
        }

        .list-connected .connect-description .status {
            padding-right: 5px;
        }


        /* REMOTE */
        .bg-remote {
            background: url("https://start.teamviewer.com/start/styles/background_globe.jpg?v=636184577786229812");
            height: 100%;
        }

        .remote-wrapper,
        .wrong-connect {
            position: absolute;
            bottom: 0;
            text-align: center;
            left: 0;
            right: 0;
        }

        .remote-wrapper {
            top: 25%;
        }

        .remote-wrapper .remote {
            max-width: 290px;
            margin: auto;
            width: 100%;
            border-top: 6px solid #2b73e8;
            border-radius: 3px;
            background: white;
            padding: 25px 25px 20px 25px;
            box-shadow: 0px 2px 2px 0px rgba(0, 0, 0, 0.3);
        }

        .remote-wrapper .form-remote {
            padding: 7px 0px;
        }

        .remote-wrapper .form-remote:last-child {
            margin-bottom: 5px;
        }

        .remote-wrapper .form-remote:after {
            content: "";
            display: block;
            clear: both;
        }

        .remote-wrapper .remote .title {
            margin-bottom: 10px;
        }

        .remote-wrapper .remote .description {
            display: block;
            text-align: left;
            padding: 10px;
        }

        .remote-wrapper .label-remote {
            margin-top: 6px;
            display: inline-block;
        }

        .remote-wrapper .inputremote {
            display: block;
            float: right;
            width: 75%;
        }

        .remote-wrapper .inputremote input {
            height: 35px;
            border-radius: 3px;
            box-shadow: none !important;
        }

        .btn-remote {
            font-size: 13px;
            color: white;
            text-align: center;
            padding: 12px 0;
            max-height: 38px;
            border-radius: 3px;
            width: 75%;
            background: #2b73e8;
            margin-top: 10px;
            border: 1px solid #cccccc;
        }

        .btn-remote:hover {
            background: #1c55b0;
        }

        .overlay-wrong-connect {
            width: 100%;
            height: 100%;
            z-index: 1;
            display: none;
        }

        .wrong-connect {
            top: 33%;
            z-index: 2;
            display: none;
        }

        .wrong-connect .error-message {
            margin: auto;
            max-width: 380px;
            background: white;
            border-radius: 3px;
            border: 3px solid #585858;
            box-shadow: 0px 2px 2px 0px rgba(0, 0, 0, 0.3);
            background: linear-gradient(to bottom, #fafafa 0%, #efefef 100%);
        }

        .wrong-connect .error-message .title h6 {
            padding: 10px;
            text-align: left;
        }

        .wrong-connect .error-message .body {
            background: #FAFAFA;
        }

        .wrong-connect .error-message .body .description {
            padding: 15px;
        }

        .wrong-connect .error-message .footer {
            border-top: 1px solid #cdcdcd;
            background: linear-gradient(to bottom, #fafafa 0%, #efefef 100%);
        }

        .wrong-connect .error-message .footer button {
            width: 20%;
            margin-bottom: 5px;
            margin-top: 6px;
            background: linear-gradient(to bottom, #757d87 0%, #576270 100%);
        }

        .confirm-close-connect {
            z-index: 30;
        }

        .iframe-connect {
            width: 100%;
            height: 100%;
            display: none;
            z-index: 10;
            position: absolute;
        }

        .user-connecting {
            background: #cce5ff !important;
        }


        /*the container must be positioned relative:*/
        .autocomplete {
            position: relative;
            display: inline-block;
        }

        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            /* display: contents; */
            /*position the autocomplete items to be the same width as the container:*/
            top: 100%;
            left: 0;
            right: 0;

            max-height: 205px;
            overflow: auto;
        }

        .autocomplete-items div {
            /* padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d4d4d4; */
        }

        /*when hovering an item:*/
        .autocomplete-items .suggest-id:hover {
            background-color: #e9e9e9;
        }

        /*when navigating through the items using the arrow keys:*/
        .autocomplete-active {
            background-color: DodgerBlue !important;
            color: #ffffff;
        }

        .autocomplete-items .suggest-id {
            border-bottom: 1px solid #d4d4d4;
            background-color: #fff;
            padding: 5px;
        }

        .autocomplete-items .suggest-id .suggest-id-value {
            float: left;
            padding: 5px 0;
            cursor: pointer;
            width: 75%;
        }

        .autocomplete-items .suggest-id .suggest-id-remove {
            cursor: pointer;
            padding: 7px 0;
            float: right;
            width: 20%;
        }

        .autocomplete-items .suggest-id .suggest-id-remove img {
            width: 15px;
        }

        .test_box_active {
            width: 100%;
            height: 100%;
            z-index: 19;
            display: block;
            position: absolute;
        }

        .uploader {
            display: none;
        }
    </style>
</head>

<body class="bg-remote">
    <div id="test_box_3"></div>

    <!-- Main content wrapper -->
    <div class="remote-wrapper">
        <div class="remote">
            <div class="title">
                <h3>Điều khiển máy tính từ xa</h3>
            </div>
            <div class="body">
                <div class="description">
                    Hãy nhập ID và Password của Đối tác mà bạn muốn kiểm soát hoặc hỗ trợ.
                </div>
                <form id="form_connect" class="form" autocomplete="off">
                    <div class="form-remote">
                        <label class="label-remote">Your ID</label>
                        <div class="inputremote autocomplete">
                            <input type="text" id="ultra_user_id" />
                        </div>
                    </div>
                    <div class="form-remote">
                        <label class="label-remote">Password</label>
                        <div class="inputremote">
                            <input type="text" id="ultra_user_password" placeholder="password" />
                        </div>
                    </div>
                    <button class="btn-remote" onclick="connectDevice()">Kết nối với đối tác</button>
                </form>
            </div>
        </div>
    </div>

    <div id="overlay_wrong_connect" class="ui-widget-overlay overlay-wrong-connect"></div>

    <div id="wrong_connect" class="wrong-connect">
        <div class="error-message">
            <div class="title">
                <h6>Dialog Title</h6>
            </div>
            <div class="body">
                <div class="description">
                    <p><img src="images/icons/color/minus-circle.png" alt="" class="icon" />
                        <span id="notice-error"></span>
                    </p>
                </div>
            </div>
            <div class="footer">
                <button onclick="closeErrorMessage()" class="btn-remote">OK</button>
            </div>
        </div>
    </div>

    <div id="close_connect" class="wrong-connect confirm-close-connect">
        <div class="error-message">
            <div class="title" style="border-bottom: 1px solid #cdcdcd;">
                <h6 style="float: left;">Dialog Title</h6>
                <input style="float: right; padding: 10px; width: 20px;" class="title-btn-close"
                    onclick="closeChatBox()" type="image" src="images/update/close.png">
                <div style="clear: both;"></div>
            </div>
            <div class="body">
                <div class="description">
                    <p>Bạn có chắc chắn ngắt kết nối không</p>
                </div>
            </div>
            <div class="footer">
                <button onclick="removeConnection(closeIdConnect)" class="btn-remote">OK</button>
                <button onclick="cancleCloseConnect()" class="btn-remote">Cancle</button>
            </div>
        </div>
    </div>

    <div id="list_iframe_connect">
        <iframe id="iframe_connect_1" class="iframe-connect" src="" frameborder="0"></iframe>
    </div>

    <!-- CHAT BOX -->
    <!-- Btn control chat box -->
    <div id="chat_box_handle" class="chat-box-handle" onclick="toggleChatBox()">
        <img style="width: 35px;" src="images/update/arrow-chat.png" alt="">
    </div>
    <!-- Chat box -->
    <div id="chat_box" class="chat-box" onmousedown="dragStartChatBox()">
        <div class="chat-box-arrow" onclick="toggleChatBox()">
            <img style="width: 35px;" src="images/update/arrow-chat.png" alt="">
        </div>
        <div class="title-chat" id="title_chat_box">
            <span class="title-label">Ultraview</span>
            <input class="title-btn-close" onclick="closeChatBox()" type="image" src="images/update/close.png">
            <div style="clear: both;"></div>
        </div>
        <div class="body-chat">
            <span>Ai đang xem máy tính của bạn</span>
            <input class="title-btn-close" onclick="newConnect()" style="width: 20px;" type="image"
                src="images/update/close.png">
            <div class="list-connected" id="list_connected">
                <div id="user_connected_1" class="connect-description user-connecting">
                    <div class="user-status" style="float:left; width: 85%;" onclick="showIframeConnect(1)">
                        <img class="status" style=" padding-top: 3px;" src="images/update/offline.png" alt="">
                        <span>ewrwerwere</span>
                    </div>
                    <div class="close-connect" onclick="confirmCloseConnection(1)"
                        style="float: right; background: red; cursor: pointer;">
                        <img src="images/update/close.png" alt="" style="width: 15px;">
                    </div>
                    <div style="clear: both;"></div>
                </div>
            </div>

            <span>Lịch sử chat</span>
            <div class="conversation" id="conversation">
                <div class="chat-partner">
                    <span class="my-mess"><b>Tôi </b>(2:29): </span>123
                </div>

                <div class="chat-partner">
                    <span class="partner-mess"><b>Máy đối tác </b>(2:29): </span>fdghidfhgih
                </div>

                <!-- File đang upload -->
                <div class="uploading-file chat-partner">
                    <div class="file-info-1">
                        <img src="images/update/file.png" alt="">
                        <div class="time-upload">10:04</div>
                    </div>
                    <div class="file-info-2">
                        <div class="progress">
                            <div class="file-name">xxx.rar</div>
                            <div class="progress-bar">
                                <div class="progress-bar-uploading">70%</div>
                            </div>
                            <div class="file-size">6.95 /119 MB</div>
                        </div>
                    </div>
                    <div class="file-info-3">
                        <img src="images/update/close.png" alt="">
                    </div>
                    <div style="clear: both;"></div>
                </div>

                <!-- File upload  thành công-->
                <div class="upload-success chat-partner">
                    <div class="file-info-1">
                        <img src="images/update/file.png" alt="">
                        <div class="time-upload">10:04</div>
                    </div>
                    <div class="file-info-2">
                        <div class="progress">
                            <div class="file-name">xxx.rar</div>
                            <div class="file-size">119 MB</div>
                            <div class="file-status">Success</div>
                        </div>
                    </div>
                    <div style="clear: both;"></div>
                </div>
            </div>

            <div class="user-chat-box">
                <textarea id="input_chat_box" style="resize: none;" class="input-chat-box" rows="1" cols=""
                    placeholder="Nhấn F1 để chat nhanh"></textarea>
                <div class="image-upload">
                    <label for="file_input">
                        <img src="images/update/attach.png" />
                    </label>
                    <input id="file_input" type="file" multiple />
                </div>
                <input class="send-message" onclick="actionSendMessage(contentChat)" type="image"
                    src="images/update/send-mess.png">
                <div style="clear: both;"></div>
            </div>
        </div>
    </div>

    <script>
        var contentChat;

        // Biến check xem là sẽ xóa iframe nào
        var closeIdConnect;

        // Check xem iframe cuối cùng đang là bao nhiêu 
        // Để khi tạo iframe mới thì sẽ gán gtri index với iframe đó
        var currentIndex = 1;

        // Check xem đây là file id bao nhiêu
        var indexSendFile = 1;

        // lưu tất cả những id mà user đã từng connect đến để lưu vào localstorage của user
        let storeIdConnect = [];

        if (typeof (Storage) !== "undefined") {
            if (localStorage.getItem('idUltraConnect') != null) {
                if (localStorage["idUltraConnect"].length > 0) {
                    storeIdConnect = JSON.parse(localStorage["idUltraConnect"]);
                }
            }
        }

        autocomplete(document.getElementById("ultra_user_id"), storeIdConnect);

        // -------------- AUTO COMPLETE WHEN INPUT ID CONNECT ------------------ //
        /*execute a function when someone writes in the text field:*/
        function autocomplete(inp, arr) {
            var currentFocus;

            inp.addEventListener("input", function (e) {
                var listSuggest;
                var suggest;
                var val = this.value;

                closeAllLists();
                if (!val) { return false; }

                currentFocus = -1;
                /*create a DIV element that will contain the items (values):*/
                listSuggest = document.createElement("DIV");
                listSuggest.setAttribute("id", this.id + "autocomplete-list");
                listSuggest.setAttribute("class", "autocomplete-items");
                /*append the DIV element as a child of the autocomplete container:*/
                this.parentNode.appendChild(listSuggest);

                /*check if the item starts with the same letters as the text field value:*/
                for (let x of arr) {
                    if (x.includes(val)) {
                        let newSuggest =
                            '<div class="suggest-id" id="suggest_id_' + x + '">' +
                            '<div class="suggest-id-value" onclick="getIdConnect(' + x + ')">' + x + '</div>' +
                            '<div class="suggest-id-remove" onclick="removeId(' + x + ')">' +
                            '<img src="images/update/delete-icon.png">' +
                            '</div>' +
                            '<div style="clear:both;"></div>' +
                            '</div>';

                        listSuggest.insertAdjacentHTML('beforeend', newSuggest);
                    }
                }
            });

            /*execute a function presses a key on the keyboard:*/
            inp.addEventListener("keydown", function (e) {
                var x = document.getElementById(this.id + "autocomplete-list");
                if (x) {
                    x = x.getElementsByClassName("suggest-id");
                }
                if (e.keyCode == 40) {  // Down
                    currentFocus++;
                    addActive(x);
                } else if (e.keyCode == 38) { // Up
                    currentFocus--;
                    addActive(x);
                } else if (e.keyCode == 13 || e.keyCode == 9) { // Enter or Tab
                    e.preventDefault();
                    $(".autocomplete-active").find(".suggest-id-value").click();

                    // if (currentFocus > -1) {
                    //     /*and simulate a click on the "active" item:*/
                    //     if (x) x[currentFocus].click();
                    // }
                } else if (e.keyCode == 27) {
                    closeListSuggest();
                }
            });

            /*a function to classify an item as "active":*/
            function addActive(x) {
                if (!x) return false;
                /*start by removing the "active" class on all items:*/
                removeActive(x);
                if (currentFocus >= x.length) {
                    currentFocus = 0;
                }

                if (currentFocus < 0) {
                    currentFocus = (x.length - 1);
                }
                /*add class "autocomplete-active":*/
                x[currentFocus].classList.add("autocomplete-active");
            }

            /*a function to remove the "active" class from all autocomplete items:*/
            function removeActive(x) {
                for (var i = 0; i < x.length; i++) {
                    x[i].classList.remove("autocomplete-active");
                }
            }

            /*close all autocomplete lists in the document,
                except the one passed as an argument:*/
            function closeAllLists(elmnt) {
                var x = document.getElementsByClassName("autocomplete-items");
                for (var i = 0; i < x.length; i++) {
                    if (elmnt != x[i] && elmnt != inp) {
                        x[i].parentNode.removeChild(x[i]);
                    }
                }
            }

            /*execute a function when someone clicks in the document:*/
            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });
        }

        function closeListSuggest() {
            $(".autocomplete-items").remove();
        }

        function getIdConnect(id) {
            $("#ultra_user_id").val(id);
            closeListSuggest();
        }

        function removeId(value) {
            for (let id of storeIdConnect) {
                if (id == value) {
                    $(`#suggest_id_` + id).remove();

                    storeIdConnect.splice(storeIdConnect.indexOf(id), 1);
                    localStorage["idUltraConnect"] = JSON.stringify(storeIdConnect);
                    break;
                }
            }
        }

        $("#form_connect").submit(function (e) {
            e.preventDefault();
        });

        // Tắt popup thông báo lỗi
        function closeErrorMessage() {
            $('#wrong_connect').css('display', 'none');
            $('#overlay_wrong_connect').css('display', 'none');
        }

        // Kết nối tới máy chủ khác (get src cho kết nối mới)
        function connectDevice() {
            closeListSuggest();
            var userId = $("#ultra_user_id").val();
            var userPassword = $("#ultra_user_password").val();

            $.get('https://ultraviewer.net/api/getserveripandport.aspx', { id: '123', pass: '123' }, function (data, textStatus, jqXHR) {
                let x = data.split(":");
                let host = x[0];
                let port = x[1];
                let url = `http://localhost/novnc/vnc.html?host=${host}&port=${port}&autoconnect=1&password=nhaidepxop`;

                if (!storeIdConnect.includes(userId)) {
                    storeIdConnect.push(userId);
                    localStorage["idUltraConnect"] = JSON.stringify(storeIdConnect);
                }

                $("#ultra_user_id").val("");
                $("#ultra_user_password").val("");

                // set url for iframe
                setIframeSrc(url);
            });
        }

        // Set src cho iframe ở trong "list_iframe_connect"
        function setIframeSrc(src) {
            // Luôn set src vào iframe cuối cùng 
            let iframeConnect = "#iframe_connect_" + currentIndex;
            $(iframeConnect).attr('src', src);

            // Hiển thị luôn iframe vừa gán đường dẫn
            showIframeConnect(currentIndex, true);
        }

        function showIframeConnect(id, addConnect) {
            hideAllElements("iframe-connect");

            let iframeConnect = "#iframe_connect_" + id;
            if ($(iframeConnect).attr('src') != "") {
                $(iframeConnect).css('display', 'block');
            }

            hideAllElements("connect-description");

            let userConnect = "#user_connected_" + id;
            $(userConnect).addClass('user-connecting');

            // Hiện đèn sáng ở chat box => xem đâu là user đang được kết nối
            // Biến addConnect này để kiểm tra 
            // xem đây có phải là kết nối vừa mới được set src không (vừa kết nối tới) hay là chỉ là switch iframe thôi
            if (addConnect) {
                $(".close-connect").css('display', 'block');

                $(userConnect).css('display', 'block');
                $(userConnect).find(".status").attr('src', 'images/update/online.png');
                $(userConnect).find("span").text(userConnect);
            }

            if (!$("#chat_box").hasClass("chat-box-open")) {
                $('#chat_box_handle').addClass('chat-box-handle-active');
            }
        }

        function confirmCloseConnection(id) {
            $("#overlay_wrong_connect").css('display', 'block');
            $("#close_connect").css('display', 'block');
            closeIdConnect = id;
        }

        function removeConnection(id) {
            // Xóa src của iframe đó đi
            let iframeConnect = "#iframe_connect_" + id;
            $(iframeConnect).remove();

            // Get id user connect ở chat box 
            let userConnect = "#user_connected_" + id;

            if ($(userConnect).hasClass("user-connecting")) {
                if ($(".connect-description").length > 1) {
                    $(userConnect).remove();
                    $("#close_connect").css('display', 'none');
                    $("#overlay_wrong_connect").css('display', 'none');

                    let newIdConnect = $(".connect-description")[0].id;
                    let newId = newIdConnect.replace("user_connected_", "");
                    showIframeConnect(newId);
                }
            }

            $(userConnect).remove();
            $("#close_connect").css('display', 'none');
            $("#overlay_wrong_connect").css('display', 'none');

            if ($(".connect-description").length == 0) {
                let newId = currentIndex + 1;
                currentIndex++;

                // Khởi tạo child mới 
                let listConnect = document.getElementById('list_connected');
                let newConnect =
                    '<div id="user_connected_' + newId + '" class="connect-description user-connecting">' +
                    '<div class="user-status" style="float:left; width: 85%;" onclick="showIframeConnect(' + newId + ')">' +
                    '<img class="status" style="padding-top: 3px;" src="images/update/offline.png" alt="">' +
                    '<span>new connection</span>' +
                    '</div>' +
                    '<div class="close-connect" onclick="confirmCloseConnection(' + newId + ')" style="float: right; background: red; cursor: pointer; display: none;">' +
                    '<img style="float: right; width: 15px; cursor: pointer;" src="images/update/close.png" alt="">' +
                    '</div>' +
                    '<div style="clear: both;"></div>' +
                    '</div>';
                listConnect.insertAdjacentHTML('beforeend', newConnect);

                // Thêm iframe kết nối
                let listIframeConnect = document.getElementById('list_iframe_connect');
                let newIframe = '<iframe id="iframe_connect_' + newId + '" class="iframe-connect" src="" frameborder="0"></iframe>';
                listIframeConnect.insertAdjacentHTML('beforeend', newIframe);
            }
        }

        function cancleCloseConnect() {
            $("#close_connect").css('display', 'none');
        }

        function hideAllElements(className) {
            let listElements = document.getElementsByClassName(className);
            for (i = 0; i < listElements.length; i++) {
                if (className == "iframe-connect") {
                    listElements[i].style.display = "none";
                } else if (className == "connect-description") {
                    listElements[i].className = listElements[i].className.replace(" user-connecting", "");
                }
            }
        }

        function checkIframeConnected(id) {
            let idIframe = "#iframe_connect_" + id;
            if ($(idIframe).attr('src') != "") {
                return true;
            }
            return false;
        }

        function newConnect() {
            let checkIframe = checkIframeConnected(currentIndex);

            // If checkIframe = true (all iframe has src) => will create new connect
            // Else return screen connect
            if (checkIframe) {
                let newId = currentIndex + 1;
                currentIndex++;

                // Khởi tạo child mới 
                let listConnect = document.getElementById('list_connected');
                let newConnect =
                    '<div id="user_connected_' + newId + '" class="connect-description user-connecting">' +
                    '<div class="user-status" style="float:left; width: 85%;" onclick="showIframeConnect(' + newId + ')">' +
                    '<img class="status" style="padding-top: 3px;" src="images/update/offline.png" alt="">' +
                    '<span>new connection</span>' +
                    '</div>' +
                    '<div class="close-connect" onclick="confirmCloseConnection(' + newId + ')" style="float: right; background: red; cursor: pointer; display: none;">' +
                    '<img style="float: right; width: 15px; cursor: pointer;" src="images/update/close.png" alt="">' +
                    '</div>' +
                    '<div style="clear: both;"></div>' +
                    '</div>';
                listConnect.insertAdjacentHTML('beforeend', newConnect);

                // Thêm iframe kết nối
                let listIframeConnect = document.getElementById('list_iframe_connect');
                let newIframe = '<iframe id="iframe_connect_' + newId + '" class="iframe-connect" src="" frameborder="0"></iframe>';
                listIframeConnect.insertAdjacentHTML('beforeend', newIframe);

                // Hiện màn hình bắt đầu kết nối
                hideAllElements("iframe-connect");

                hideAllElements("connect-description");
                let userConnect = "#user_connected_" + newId;
                $(userConnect).addClass('user-connecting');

            } else {
                showIframeConnect(currentIndex)
            }
        }

        function cancleSendFile(id) {
            let idFile = "#" + id;
            $(idFile).find(".progress-bar").remove();
            $(idFile).find(".file-info-3").remove();

            let statusFile = '<div class="file-status">Cancle</div>';
            $(idFile).find(".file-size").append(statusFile);
        }

        // position left of Chat box when user move 
        var posLeftChatBox = -1;

        // TOGGLE OPEN CHAT BOX
        function openChatBox() {
            // console.log("Open");
            document.getElementById('chat_box').classList.add("chat-box-open");
            $('#chat_box_handle').removeClass("chat-box-handle-active");

            if (posLeftChatBox == -1) {
                let cssLeftChatBox = screen.width - $('#chat_box').width() - 16;
                $('#chat_box').css('left', cssLeftChatBox);
            }

            setTimeout(function () {
                document.getElementById('input_chat_box').focus();
            }, 100);
        }

        function closeChatBox() {
            // console.log("Close");
            posLeftChatBox = $('#chat_box').position().left;
            document.getElementById('chat_box').classList.remove("chat-box-open");
            $('.chat-box-handle').addClass('chat-box-handle-active');
        }

        function toggleChatBox() {
            // console.log("Toggle father");
            if (document.getElementById("chat_box").classList.contains("chat-box-open")) {
                closeChatBox();
            } else {
                openChatBox();
            }
        }

        // -------------- HANDLE CHAT BOX --------------------- //
        // Button F1 - open chat box
        shortcut.add("F1", function () {
            toggleChatBox();
        });

        function getCaret(el) {
            if (el.selectionStart) {
                return el.selectionStart;
            } else if (document.selection) {
                el.focus();
                var r = document.selection.createRange();
                if (r == null) {
                    return 0;
                }
                var re = el.createTextRange(), rc = re.duplicate();
                re.moveToBookmark(r.getBookmark());
                rc.setEndPoint('EndToStart', re);
                return rc.text.length;
            }
            return 0;
        }

        // Enter send message
        $('#input_chat_box').keyup(function (event) {
            let rowsTextArea = $('#input_chat_box').attr('rows');

            if (event.keyCode == 13) {
                var content = this.value;
                var caret = getCaret(this);
                if (event.shiftKey) {
                    this.value = content.substring(0, caret - 1) + "\n" + content.substring(caret, content.length);
                    if (rowsTextArea <= 3) {
                        rowsTextArea++;
                    }
                    $('#input_chat_box').attr('rows', rowsTextArea);
                    contentChat = this.value;
                    event.stopPropagation();
                } else {
                    this.value = content.substring(0, caret - 1) + content.substring(caret, content.length);
                    sendMessage(this.value);
                }
            }
        });

        // Button send message
        function actionSendMessage(message) {
            var getTextArea = $("#input_chat_box");
            var content = getTextArea.val();
            var caret = getCaret(getTextArea);
            getTextArea.value = content.substring(0, caret - 1) + content.substring(caret, content.length);
            sendMessage(getTextArea.value);
        }

        function sendMessage(message) {
            // Get time now
            let d = new Date();
            let hours = d.getHours();
            let min = d.getMinutes();

            // Add new node chat to the conversation and refresh
            let parent = document.getElementById('conversation');
            let newChild =
                '<div class="chat-partner">' +
                '<span class="my-mess"><b>Tôi </b>(' + hours + ':' + min + '): </span >' +
                '<span style = "white-space: pre-wrap;">' + message + '</span>' +
                '</div > ';
            parent.insertAdjacentHTML('beforeend', newChild);
            $('#input_chat_box').val("");
            $('#input_chat_box').attr('rows', 1);
            scrollLastestChat();
        }

        // Scroll to the lastest chat
        function scrollLastestChat() {
            let listChat = document.getElementsByClassName("chat-partner");
            let lastChat = listChat[listChat.length - 1];
            lastChat.scrollIntoView({ behavior: 'smooth' });
        }

        function infoFileSend(listFiles) {
            // files is a FileList of File objects. List some properties.
            for (let file of listFiles) {
                let idFile = "file_send_" + indexSendFile;
                let idProgressBar = "progress_bar_" + indexSendFile;

                let fileSize = file.size / Math.pow(10, 6);
                let parent = document.getElementById('conversation');

                let newChild =
                    '<div class="uploading-file chat-partner" id="' + idFile + '" > ' +
                    '<div class="file-info-1">' +
                    '<img src="images/update/file.png" alt="">' +
                    '<div class="time-upload">10:04</div>' +
                    '</div>' +
                    '<div class="file-info-2">' +
                    '<div class="progress">' +
                    '<div class="file-name">' + file.name + '</div>' +
                    '<div class="progress-bar" id="' + idProgressBar + '">' +
                    '<div class="progress-bar-uploading">70%</div>' +
                    '</div>' +
                    '<div class="file-size">' + fileSize.toFixed(2) + 'MB</div>' +
                    '</div>' +
                    '</div>' +
                    '<div class="file-info-3">' +
                    '<img src="images/update/close.png" alt="" style="cursor:pointer;" onclick="cancleSendFile(`' + idFile + '`)">' +
                    '</div>' +
                    '<div style="clear: both;"></div>' +
                    '</div>';

                parent.insertAdjacentHTML('beforeend', newChild);

                indexSendFile++;
            }
            scrollLastestChat();
        }

        // Drag file to chat box
        function handleFileDrag(evt) {
            evt.stopPropagation();
            evt.preventDefault();

            var listFiles = evt.dataTransfer.files; // listFils send in 1 turn
            infoFileSend(listFiles);
        }

        // Drag file to chat box
        function handleFileSelect(evt) {
            evt.stopPropagation();
            evt.preventDefault();

            var listFiles = evt.target.files; // FileList object
            infoFileSend(listFiles);
        }

        // Giữ file thả vào chat box => hiện chữ "move"
        function handleDragOver(evt) {
            evt.stopPropagation();
            evt.preventDefault();
            evt.dataTransfer.dropEffect = 'move'; // Explicitly show this is a move.
        }

        // Mouse down => Start move chat box
        function dragStartChatBox() {
            $('#test_box_3').addClass("test_box_active");
        }

        // Mouse up => check div cover all screen => remove 
        $(document).mouseup(function () {
            if ($("#test_box_3").hasClass("test_box_active")) {
                $('#test_box_3').removeClass("test_box_active");
            }
        });

        $("#chat_box").draggable({
            containment: "window",
            handle: '.title-chat',
        });

        function toggleFullScreen() {
            if (document.fullscreenElement || // alternative standard method
                document.mozFullScreenElement || // currently working methods
                document.webkitFullscreenElement ||
                document.msFullscreenElement) {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            } else {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.mozRequestFullScreen) {
                    document.documentElement.mozRequestFullScreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                } else if (document.body.msRequestFullscreen) {
                    document.body.msRequestFullscreen();
                }
            }
        }

        // Setup the dnd listeners.
        var dropZone = document.getElementById('chat_box');
        dropZone.addEventListener('dragover', handleDragOver, false);
        dropZone.addEventListener('drop', handleFileDrag, false);
        document.getElementById('file_input').addEventListener('change', handleFileSelect, false);

        // ---------------- CATCH EVENT FROM CHILD (NOVNC) ----------------- //
        // Get all event from child (noVNC) - Check event từ thằng con là noVNC bắn lên
        var eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
        var eventer = window[eventMethod];
        var messageEvent = eventMethod === "attachEvent" ? "onmessage" : "message";

        eventer(messageEvent, function (e) {
            let nameEvent = e.data.name_event;

            if (nameEvent == "toggle-chat-box") {
                toggleChatBox();
            }

            if (nameEvent == "toggle-full-screen") {
                toggleFullScreen();
            }

            // Hiện lỗi nếu không kết nối được tới máy chủ
            if (nameEvent == "connect-error") {
                let status = e.data.status;
                if (status != "normal") {
                    listError.push(e);
                    // clear iframe and alert error why cannot connect to no vnc
                    $("#frame-connect").remove();

                    // always return notice error (1st element of list Error)
                    $("#notice-error").text(listError[0].data.mess);
                    $('.remote-wrapper').css('display', 'block');
                    $('#wrong_connect').css('display', 'block');
                    $('#overlay_wrong_connect').css('display', 'block');
                }
            }
        });
    </script>
</body>

</html>